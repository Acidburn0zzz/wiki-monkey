// Generated by CoffeeScript 1.12.2
var CSS, DOM;

CSS = require('../../lib.js.generic/dist/CSS');

DOM = require('../../lib.js.generic/dist/DOM');

module.exports.ArchWikiRCFilter = (function() {
  ArchWikiRCFilter.REQUIRES_GM = false;

  function ArchWikiRCFilter(WM) {
    this.WM = WM;
  }

  ArchWikiRCFilter.prototype.main = function(params) {
    var articleTable, articleTables, groupDiv, h4, h4s, j, k, l, len, len1, len2, link, links, title;
    h4s = DOM.getChildrenByTagName(document.getElementById('mw-content-text').getElementsByClassName('mw-changeslist')[0], 'h4');
    if (DOM.getNextElementSibling(h4s[0]).localName.toLowerCase() !== 'div') {
      return this.WM.Log.logError("This filter is designed to work on top of MediaWiki's filter, which you can enable in your user preferences.");
    } else {
      CSS.addStyleElement("#mw-content-text > div > h4 {background-color:#aaf;} #mw-content-text > div > div > h5 {background-color:#afa;}");
      for (j = 0, len = h4s.length; j < len; j++) {
        h4 = h4s[j];
        groupDiv = DOM.getNextElementSibling(h4);
        articleTables = DOM.getChildrenByTagName(groupDiv, 'table');
        for (k = 0, len1 = articleTables.length; k < len1; k++) {
          articleTable = articleTables[k];
          links = articleTable.getElementsByTagName('a');
          for (l = 0, len2 = links.length; l < len2; l++) {
            link = links[l];
            if (link.className === 'mw-changeslist-title') {
              title = link.title;
              this.WM.Plugins.ArchWikiRCFilter.moveArticle(params, groupDiv, articleTable, title);
              break;
            }
          }
        }
      }
      return this.WM.Log.logInfo("Grouped articles by language");
    }
  };

  ArchWikiRCFilter.prototype.moveArticle = function(params, groupDiv, articleTable, title) {
    var HLang, i, j, lang, langFound, langH, langHs, language, pureTitle, ref;
    lang = this.WM.ArchWiki.detectLanguage(title);
    pureTitle = lang[0];
    language = lang[1];
    if (language !== params.language) {
      langHs = DOM.getChildrenByTagName(groupDiv, 'h5');
      langFound = false;
      for (i = j = 0, ref = langHs.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        HLang = langHs[i];
        if (HLang.innerHTML === language) {
          if (i + 1 < langHs.length) {
            groupDiv.insertBefore(articleTable, langHs[i + 1]);
          } else {
            groupDiv.appendChild(articleTable);
          }
          langFound = true;
          break;
        }
      }
      if (!langFound) {
        langH = document.createElement('h5');
        langH.innerHTML = language;
        groupDiv.appendChild(langH);
        return groupDiv.appendChild(articleTable);
      }
    }
  };

  return ArchWikiRCFilter;

})();
