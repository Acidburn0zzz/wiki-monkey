// Generated by CoffeeScript 1.12.7
var CSS, HTTP,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

CSS = require('../../lib.js.generic/dist/CSS');

HTTP = require('../../lib.js.generic/dist/HTTP');

module.exports.ArchWikiSaveTalk = (function() {
  ArchWikiSaveTalk.REQUIRES_GM = false;

  function ArchWikiSaveTalk(WM) {
    this.WM = WM;
    this.mainEnd = bind(this.mainEnd, this);
    this.mainWrite = bind(this.mainWrite, this);
    this.mainGetEndTimestamp = bind(this.mainGetEndTimestamp, this);
  }

  ArchWikiSaveTalk.prototype.makeUI = function(args) {
    var article, link;
    CSS.addStyleElement("#WikiMonkey-ArchWikiSaveTalk {margin-left:0.33em;}");
    article = args[0];
    link = document.createElement('a');
    link.id = "WikiMonkey-ArchWikiSaveTalk";
    link.href = "/index.php/" + article;
    link.innerHTML = article;
    return link;
  };

  ArchWikiSaveTalk.prototype.main = function(args, callNext) {
    var article, summary;
    article = args[0];
    summary = args[1];
    this.WM.Log.logInfo('Appending diff to ' + this.WM.Log.linkToWikiPage(article, article) + " ...");
    return this.WM.Diff.getEndTimestamp(this.mainGetEndTimestamp, [article, summary, callNext]);
  };

  ArchWikiSaveTalk.prototype.mainGetEndTimestamp = function(enddate, args) {
    var article, callNext, summary;
    article = args[0];
    summary = args[1];
    callNext = args[2];
    return this.WM.MW.callQueryEdit(article, this.mainWrite, [summary, enddate, callNext]);
  };

  ArchWikiSaveTalk.prototype.mainWrite = function(article, source, timestamp, edittoken, args) {
    var callNext, enddate, newtext, pEnddate, summary, title;
    summary = args[0];
    enddate = args[1];
    callNext = args[2];
    title = HTTP.getURIParameter(null, 'title');
    pEnddate = enddate.substr(0, 10) + "&nbsp;" + enddate.substr(11, 8);
    newtext = this.WM.Tables.appendRow(source, "<!-- REPLY TABLE -->", ["[" + location.href + " " + title + "]", pEnddate]);
    return this.WM.MW.callAPIPost({
      action: "edit",
      bot: "1",
      title: article,
      summary: summary,
      text: newtext,
      basetimestamp: timestamp,
      token: edittoken
    }, null, this.mainEnd, [article, callNext], null);
  };

  ArchWikiSaveTalk.prototype.mainEnd = function(res, args) {
    var article, callNext;
    article = args[0];
    callNext = args[1];
    if (res.edit && res.edit.result === 'Success') {
      this.WM.Log.logInfo('Diff correctly appended to ' + this.WM.Log.linkToWikiPage(article, article));
      if (callNext) {
        return callNext();
      }
    } else {
      return this.WM.Log.logError('The diff has not been appended!\n' + res['error']['info'] + " (" + res['error']['code'] + ")");
    }
  };

  return ArchWikiSaveTalk;

})();
